<!DOCTYPE html>
<html lang="es">
<head>
  <script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard PM | Sanbai (Corporate)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #2d3748; }
    .top-bar { background: linear-gradient(135deg, #003d82 0%, #00529e 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .top-bar-left { display: flex; align-items: center; gap: 20px; }
    .top-bar-right { display:flex; align-items:center; gap:10px; }
    .top-bar h1 { font-size: 1.5em; }
    .project-selector { display: flex; gap: 10px; align-items: center; }
    .project-selector select { padding: 8px 15px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn-white { background: white; color: #003d82; }
    .btn-success { background: #48bb78; color: white; }
    .btn-primary { background: #003d82; color: white; }
    .btn-danger { background: #f56565; color: white; }

    .container { padding: 20px; max-width: 1600px; margin: 0 auto; }
    .project-header { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .project-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
    .info-item { display: flex; flex-direction: column; gap: 5px; }
    .info-label { font-size: 0.85em; color: #718096; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value { font-size: 1.1em; font-weight: bold; color: #2d3748; }
    .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
    .status-en-curso { background: #dbeafe; color: #1e40af; }

    .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    .left-panel { display: flex; flex-direction: column; gap: 20px; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
    .card-title { font-size: 1.2em; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .tasks-list { display: flex; flex-direction: column; gap: 10px; }
    .task-item { background: #f7fafc; border-left: 4px solid #cbd5e0; padding: 15px; border-radius: 6px; transition: all 0.3s ease; cursor: pointer; }
    .task-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .task-item.completed { border-left-color: #48bb78; opacity: 0.7; }
    .task-item.in-progress { border-left-color: #003d82; }
    .task-item.pending { border-left-color: #e89e3c; }
    .task-item.blocked { border-left-color: #f56565; }
    .task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
    .task-title { font-weight: 600; font-size: 1em; }
    .task-status { padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold; }
    .task-meta { display: flex; gap: 15px; font-size: 0.85em; color: #718096; margin-top: 8px; }
    .task-meta-item { display: flex; align-items: center; gap: 5px; }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #003d82 0%, #00529e 100%); transition: width 0.3s ease; }

    .gantt-container { overflow-x: auto; margin-top: 15px; }
    .gantt-chart { min-width: 800px; }
    .gantt-header { display: flex; background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 5px; font-weight: 600; font-size: 0.85em; }
    .gantt-task-name { width: 200px; flex-shrink: 0; }
    .gantt-timeline { flex: 1; display: flex; position: relative; }
    .gantt-row { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
    .gantt-row:hover { background: #f7fafc; }
    .gantt-bar { height: 24px; border-radius: 4px; position: absolute; display: flex; align-items: center; padding: 0 8px; font-size: 0.75em; color: white; font-weight: 600; white-space: nowrap; }

    .right-panel { display: flex; flex-direction: column; gap: 20px; }
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .metric-card { background: linear-gradient(135deg, #003d82 0%, #00529e 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 61, 130, 0.3); }
    .metric-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
    .metric-label { font-size: 0.85em; opacity: 0.9; }

    .team-list { display: flex; flex-direction: column; gap: 10px; }
    .team-member { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f7fafc; border-radius: 8px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #003d82 0%, #00529e 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
    .member-info { flex: 1; }
    .member-name { font-weight: 600; font-size: 0.95em; }
    .member-role { font-size: 0.8em; color: #718096; }

    .critical-list { display: flex; flex-direction: column; gap: 8px; }
    .critical-item { padding: 12px; background: #fff5f5; border-left: 4px solid #f56565; border-radius: 6px; font-size: 0.9em; }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: inherit; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #003d82; }
    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
    .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #718096; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.3s ease; }
    .tab:hover { color: #003d82; }
    .tab.active { color: #003d82; border-bottom-color: #003d82; }

    @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }

    /* ===== Sanbai corporate theme overrides ===== */
    :root{
      --sanbai-orange:#ff7a00;
      --sanbai-dark:#1c1c1c;
      --sanbai-gray:#2f2f2f;
      --sanbai-light:#f5f5f5;
    }

    body{ background: var(--sanbai-light); color: var(--sanbai-dark); }
    .top-bar{
      background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%);
      box-shadow: 0 8px 24px rgba(0,0,0,0.10);
    }

    .logo-img{
      height: 34px;
      background: white;
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
    }

    .btn{ border-radius: 10px; }
    .btn-white{ background: white; color: var(--sanbai-dark); }
    .btn-primary{ background: var(--sanbai-orange); color: white; }
    .btn-primary:hover{ box-shadow: 0 10px 22px rgba(255,122,0,0.25); }

    .project-header{ border-left: 6px solid var(--sanbai-orange); }
    .card{ border-radius: 12px; box-shadow: 0 10px 26px rgba(0,0,0,0.08); }
    .card-header{ border-bottom: 1px solid #e5e7eb; }
    .card-title{ color: var(--sanbai-dark); }

    .tab:hover{ color: var(--sanbai-dark); }
    .tab.active{ color: var(--sanbai-dark); border-bottom-color: var(--sanbai-orange); }

    .task-item.in-progress{ border-left-color: var(--sanbai-orange); }
    .progress-fill{ background: linear-gradient(90deg, var(--sanbai-orange) 0%, #ff9a3d 100%); }

    .status-en-curso{
      background: #fff2e8; color: #7a2e00;
      border: 1px solid rgba(255,122,0,0.25);
    }

    .metric-card{
      background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%);
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
    }
    .metric-card.metric-accent{
      background: linear-gradient(135deg, var(--sanbai-orange) 0%, #ff9a3d 100%);
      box-shadow: 0 10px 22px rgba(255,122,0,0.20);
    }
    .metric-card.metric-ok{ background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); }
    .metric-card.metric-warn{ background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
    .metric-card.metric-bad{ background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }

    .avatar{ background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%); }
 
    @page {
  size: A4 landscape;
  margin: 10mm;
}

html, body {
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}
    /* =========================
   PDF MODE
========================= */
body.pdf-mode {
  background: white;
}

body.pdf-mode .btn,
body.pdf-mode .project-selector,
body.pdf-mode .tabs,
body.pdf-mode .modal,
body.pdf-mode #connStatus {
  display: none !important;
}

body.pdf-mode .container {
  max-width: none;
  padding: 0;
}

body.pdf-mode .main-content {
  grid-template-columns: 1fr !important;
}

body.pdf-mode .right-panel {
  margin-top: 24px;
}

body.pdf-mode .card,
body.pdf-mode .task-item,
body.pdf-mode .team-member,
body.pdf-mode .critical-item {
  break-inside: avoid;
  page-break-inside: avoid;
}

body.pdf-mode .gantt-container {
  overflow: visible !important;
}

@page {
  size: A4 landscape;
  margin: 10mm;
}

@media print {
  html, body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}


    @media print{
      .top-bar{ box-shadow:none; }
      .btn, .project-selector, .tabs, .modal{ display:none !important; }
      body{ background:white; }
      .container{ max-width:none; padding:0; }
      .card{ box-shadow:none; border:1px solid #e5e7eb; }
      .project-header{ box-shadow:none; border:1px solid #e5e7eb; border-left: 6px solid var(--sanbai-orange); }
      .main-content{ grid-template-columns: 1fr; }
      .right-panel{ break-before: page; }
       /* Ocultar UI interactiva + overlays */
  .btn, .project-selector, .tabs, .modal { display: none !important; }
  #connStatus { display: none !important; } /* <- clave (tu toast) */
  
  /* Evitar cortes feos */
  .card, .task-item, .team-member, .critical-item {
    break-inside: avoid;
    page-break-inside: avoid;
    }
        /* Que el layout sea â€œreporteâ€ */
  body { background: white !important; }
  .container { max-width: none; padding: 0; }
  .main-content { grid-template-columns: 1fr !important; }
  .right-panel { break-before: page; }

  /* Gantt: que no corte por overflow */
  .gantt-container { overflow: visible !important; }
  .gantt-chart { min-width: 0 !important; }
}
  
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-bar-left">
      <img src="logo.png" class="logo-img" alt="Sanbai Solutions">
      <h1>Dashboard PM</h1>
     
    </div>

    <div class="project-selector">
      <a id="btnProjectInfo" class="btn btn-white" href="#" target="_blank" rel="noopener">
        <i class="fa-solid fa-circle-info"></i> Info proyecto
      </a>

      <button id="btnPrint" class="btn btn-white" type="button" title="Imprimir / Guardar PDF">
        <i class="fa-solid fa-print"></i> Imprimir
      </button>

      <button id="btnExportPDF" class="btn btn-white" type="button" title="Abrir impresiÃ³n para exportar como PDF">
        <i class="fa-solid fa-file-pdf"></i> Exportar PDF
      </button>

     <button id="btnLogout" class="btn btn-white"  title="Cerrar sesiÃ³n">
  ðŸ”’ Logout
</button>


      <select id="projectSelector"></select>
    </div>
  </div>

  <div class="container">
    <div class="project-header">
      <div style="display:flex; justify-content:space-between; align-items:start;">
        <div>
          <h2>Torre Macro - Red LAN</h2>
          <p style="color:#718096; margin-top:5px;">ActualizaciÃ³n TecnolÃ³gica Infraestructura Red Cableada Huawei</p>
        </div>
        <span class="status-badge status-en-curso">En Curso</span>
      </div>

      <div class="project-info-grid">
        <div class="info-item"><span class="info-label">Cliente</span><span class="info-value">â€”</span></div>
        <div class="info-item"><span class="info-label">Monto</span><span class="info-value">â€”</span></div>
        <div class="info-item"><span class="info-label">Inicio</span><span class="info-value">â€”</span></div>
        <div class="info-item"><span class="info-label">Fin Estimado</span><span class="info-value">â€”</span></div>
        <div class="info-item"><span class="info-label">PM Responsable</span><span class="info-value">â€”</span></div>
      </div>
    </div>

    <div class="main-content">
      <div class="left-panel">
        <div class="card">
          <div class="card-header">
            <span class="card-title"><i class="fa-solid fa-list-check"></i> Tareas del Proyecto</span>
            <button id="btnNewTask" class="btn btn-primary" type="button">
              <i class="fa-solid fa-plus"></i> Nueva Tarea
            </button>
          </div>

          <div class="tabs">
            <div class="tab active" data-tab="all">Todas</div>
            <div class="tab" data-tab="pending">Pendientes</div>
            <div class="tab" data-tab="in-progress">En Curso</div>
            <div class="tab" data-tab="completed">Completadas</div>
            <div class="tab" data-tab="blocked">Bloqueadas</div>
          </div>

          <div id="tasksList" class="tasks-list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title"><i class="fa-solid fa-chart-gantt"></i> Cronograma (Gantt)</span>
            <button class="btn btn-white" type="button" id="btnExportGantt">
              <i class="fa-solid fa-download"></i> Exportar
            </button>
          </div>
          <div class="gantt-container" id="ganttChart"></div>
        </div>
      </div>

      <div class="right-panel">
        <div class="card">
          <div class="card-title" style="margin-bottom:15px;"><i class="fa-solid fa-chart-line"></i> MÃ©tricas</div>
          <div class="metrics-grid">
            <div class="metric-card metric-accent">
              <div class="metric-label">Progreso Total</div>
              <div class="metric-value" id="metricProgress">â€”</div>
            </div>
            <div class="metric-card metric-ok">
              <div class="metric-label">Completadas</div>
              <div class="metric-value" id="metricCompleted">â€”</div>
            </div>
            <div class="metric-card metric-warn">
              <div class="metric-label">DÃ­as Restantes</div>
              <div class="metric-value" id="metricDays">â€”</div>
            </div>
            <div class="metric-card metric-bad">
              <div class="metric-label">Bloqueadores</div>
              <div class="metric-value" id="metricBlocked">â€”</div>
            </div>
  
          </div>
        </div>

        <div class="card">
          <div class="card-title" style="margin-bottom:15px;"><i class="fa-solid fa-users"></i> Equipo</div>
          <div class="team-list" id="teamList"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title"><i class="fa-solid fa-sack-dollar"></i> Cashflow (Fechas clave)</span>
            <button id="btnNewCashflow" class="btn btn-primary" type="button" title="Nuevo evento cashflow">
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
          <div class="critical-list" id="cashflowList"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> Riesgos y Bloqueadores</span>
            <button class="btn btn-danger" type="button" onclick="alert('PrÃ³ximamente')">âž•</button>
          </div>
          <div class="critical-list" id="criticalList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tareas -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="taskModalTitle">Nueva Tarea</div>
      <form id="taskForm">
        <div class="form-group">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-input" id="taskName" required>
        </div>
        <div class="form-group">
          <label class="form-label">DescripciÃ³n</label>
          <textarea class="form-textarea" id="taskDesc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Responsable</label>
          <select class="form-select" id="taskOwner">
            <option>SebastiÃ¡n Pittaluga</option>
            <option>Luis Gomez</option>
            <option>Sebastian Borghello</option>
            <option>Huawei</option>
            <option>Qualix</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" id="taskStatus">
            <option value="pending">Pendiente</option>
            <option value="in-progress">En Curso</option>
            <option value="completed">Completada</option>
            <option value="blocked">Bloqueada</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Fecha Inicio</label>
          <input type="date" class="form-input" id="taskStart">
        </div>
        <div class="form-group">
          <label class="form-label">Fecha Fin</label>
          <input type="date" class="form-input" id="taskEnd">
        </div>
        <div class="form-group">
          <label class="form-label">Progreso (%)</label>
          <input type="number" class="form-input" id="taskProgress" min="0" max="100" value="0">
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-white" id="btnCancelTask">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Cashflow -->
  <div id="cashflowModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="cashflowModalTitle">Nuevo evento de Cashflow</div>
      <form id="cashflowForm">
        <div class="form-group">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-input" id="cfDate" required>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="cfType" required>
            <option value="Cobro">Cobro</option>
            <option value="Pago">Pago</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Concepto</label>
          <input type="text" class="form-input" id="cfType" placeholder="Ej: Cobro hito entrega / Pago proveedor" required>
        </div>

        <div class="form-group">
          <label class="form-label">Contraparte</label>
          <input type="text" class="form-input" id="cfParty" placeholder="Ej: Banco Macro / Intermaco / Qualix">
        </div>

        <div class="form-group" style="display:grid; grid-template-columns: 1fr 140px; gap:10px;">
          <div>
            <label class="form-label">Monto</label>
            <input type="number" class="form-input" id="cfAmount" step="0.01" required>
          </div>
          <div>
            <label class="form-label">Moneda</label>
            <select class="form-select" id="cfCurrency">
              <option value="USD">USD</option>
              <option value="ARS">ARS</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" id="cfStatus">
            <option value="Planificado">Planificado</option>
            <option value="Confirmado">Confirmado</option>
            <option value="Ejecutado">Ejecutado</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Notas</label>
          <textarea class="form-textarea" id="cfNotes" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-white" id="btnCancelCashflow">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  /* ===============================
   Sanbai PM Dashboard (Airtable)
   - Single source of truth: Airtable (via Netlify Function)
   - Auth: Netlify Identity (JWT -> Authorization: Bearer <token>)
   =============================== */

const API_BASE = "/.netlify/functions/airtable";
const STORAGE_KEY = "pm_projects_v1";

// Map projectKey -> info page
const PROJECT_INFO_LINKS = {
  macro_lan: "https://sanbai-pm-dashboard.netlify.app/proyecto-macro-dashboard-sanbai.html",
  storage_backup: "https://sanbai-pm-dashboard.netlify.app/proyecto-storage-backup-dashboard-sanbai.html",
};

// ===== State =====
let projects = {};              // loaded from backend
let currentProjectKey = null;
let currentProject = null;
let currentTab = "all";
let editingTaskRecordId = null;

// Netlify Identity
let identityUser = null;

// ===== Small helpers =====
function $(id){ return document.getElementById(id); }

function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }

function showConnectionStatus(ok, msg) {
  let el = document.getElementById("connStatus");
  if (!el) {
    el = document.createElement("div");
    el.id = "connStatus";
    el.style.position = "fixed";
    el.style.bottom = "16px";
    el.style.left = "16px";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "10px";
    el.style.fontSize = "12px";
    el.style.fontWeight = "600";
    el.style.zIndex = "2000";
    el.style.boxShadow = "0 10px 22px rgba(0,0,0,0.12)";
    document.body.appendChild(el);
  }
  if (ok) {
    el.textContent = msg || "Conectado";
    el.style.background = "rgba(34,197,94,0.95)";
    el.style.color = "white";
  } else {
    el.textContent = msg || "Desconectado";
    el.style.background = "rgba(245,158,11,0.95)";
    el.style.color = "white";
  }
  setTimeout(() => { try { el.remove(); } catch(e){} }, 8000);
}

function updateProjectInfoButton(projectKey) {
  const btn = document.getElementById("btnProjectInfo");
  if (!btn) return;
  const url = PROJECT_INFO_LINKS[projectKey];
  if (url) {
    btn.href = url;
    btn.style.display = "inline-flex";
  } else {
    btn.href = "#";
    btn.style.display = "none";
  }
}

// ===== Auth =====
async function getAuthHeaders(extra = {}) {
  if (!identityUser) {
    // in case Identity is present but not set yet:
    identityUser = window.netlifyIdentity?.currentUser?.() || null;
  }
  if (!identityUser) return extra; // will likely 401; caller can handle
  // Netlify Identity uses jwt() to fetch a fresh token
  let token = "";
  try {
    if (typeof identityUser.jwt === "function") token = await identityUser.jwt();
    else if (identityUser.token?.access_token) token = identityUser.token.access_token;
  } catch (e) {
    console.warn("[Auth] No se pudo obtener JWT:", e);
  }
  if (!token) return extra;
  return { ...extra, Authorization: "Bearer " + token };
}

async function requireLoginThenStart() {
  if (!window.netlifyIdentity) {
    console.error("[Auth] Netlify Identity no cargÃ³");
    showConnectionStatus(false, "Auth no disponible (Identity no cargÃ³)");
    return;
  }

  // Bind logout button if present
  const logoutBtn = document.getElementById("btnLogout");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => window.netlifyIdentity.logout());
  }

  window.netlifyIdentity.init();

  window.netlifyIdentity.on("init", async (user) => {
    identityUser = user || null;
    if (identityUser) {
    //  await startApp();
    } else {
      window.netlifyIdentity.open(); // show login modal
    }
  });

  window.netlifyIdentity.on("login", async (user) => {
    identityUser = user || null;
    window.netlifyIdentity.close();
  // await startApp();
  });

  window.netlifyIdentity.on("logout", () => {
    identityUser = null;
    // clean UI state
    projects = {};
    currentProjectKey = null;
    currentProject = null;
    showConnectionStatus(false, "SesiÃ³n cerrada");
    window.netlifyIdentity.open();
  });
}

// ===== Backend =====
async function loadFromBackend() {
  const headers = await getAuthHeaders({ "Content-Type": "application/json" });
  const r = await fetch(API_BASE, { headers, cache: "no-store" });
  const text = await r.text();
  let data;
  try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

  if (!r.ok) {
    throw new Error(`Airtable backend error: ${r.status} ${JSON.stringify(data)}`);
  }
  if (!data || !data.projects) throw new Error("Respuesta invÃ¡lida del backend (sin projects)");
  return data.projects;
}

async function apiJSON(method, url, body) {
  const headers = await getAuthHeaders({ "Content-Type": "application/json" });
  const r = await fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });
  const text = await r.text();
  let data;
  try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
  if (!r.ok) throw new Error(`${method} ${url} -> ${r.status} ${JSON.stringify(data)}`);
  return data;
}

async function createTaskRemote(taskData) {
  const payload = { projectKey: currentProjectKey, ...taskData };
  const data = await apiJSON("POST", `${API_BASE}/tasks`, payload);
  if (!data.ok) throw new Error(data.error || "No se pudo crear tarea");
  return data.record; // Airtable record
}

async function updateTaskRemote(recordId, taskData) {
  const data = await apiJSON("PATCH", `${API_BASE}/tasks/${recordId}`, taskData);
  if (!data.ok) throw new Error(data.error || "No se pudo actualizar tarea");
  return data.record;
}

async function deleteTaskRemote(recordId) {
  const data = await apiJSON("DELETE", `${API_BASE}/tasks/${recordId}`);
  if (!data.ok) throw new Error(data.error || "No se pudo borrar tarea");
  return data.deleted;
}

// ===== Persistence (optional local fallback) =====
function persistProjects() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(projects)); } catch(e){}
}
function loadProjectsFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch(e) { return null; }
}

// ===== UI =====
function renderProjectSelector() {
  const sel = $("projectSelector");
  if (!sel) return;

  const entries = Object.entries(projects);
  sel.innerHTML = entries.map(([key, p]) => {
    const label = p?.meta?.name ? p.meta.name : key;
    return `<option value="${key}">${escapeHtml(label)}</option>`;
  }).join("");

  sel.value = currentProjectKey;

  sel.onchange = () => {
    currentProjectKey = sel.value;
    currentProject = projects[currentProjectKey];
    currentTab = "all";
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    const allTab = document.querySelector('.tab[data-tab="all"]');
    if (allTab) allTab.classList.add("active");
    updateProjectInfoButton(currentProjectKey);
    renderAll();
  };
}

function renderProjectMeta() {
  if (!currentProject) return;
  const h2 = document.querySelector(".project-header h2");
  const p = document.querySelector(".project-header p");
  const status = document.querySelector(".status-badge");
  if (h2) h2.textContent = safeText(currentProject.meta?.name);
  if (p) p.textContent = safeText(currentProject.meta?.subtitle);
  if (status) status.textContent = safeText(currentProject.meta?.statusLabel);

  const infoValues = document.querySelectorAll(".project-info-grid .info-value");
  if (infoValues.length >= 5) {
    infoValues[0].textContent = safeText(currentProject.meta?.client);
    infoValues[1].textContent = safeText(currentProject.meta?.amount);
    infoValues[2].textContent = safeText(currentProject.meta?.start);
    infoValues[3].textContent = safeText(currentProject.meta?.end);
    infoValues[4].textContent = safeText(currentProject.meta?.pm);
  }
}

function toSortableDate(iso) {
  if (!iso) return Number.POSITIVE_INFINITY;
  const d = new Date(iso + "T00:00:00");
  const t = d.getTime();
  return Number.isFinite(t) ? t : Number.POSITIVE_INFINITY;
}
function sortTasksByDate(tasks) {
  return [...tasks].sort((a, b) => {
    const aStart = toSortableDate(a.startDate);
    const bStart = toSortableDate(b.startDate);
    if (aStart !== bStart) return aStart - bStart;
    const aEnd = toSortableDate(a.endDate);
    const bEnd = toSortableDate(b.endDate);
    if (aEnd !== bEnd) return aEnd - bEnd;
    return safeText(a.name).localeCompare(safeText(b.name), "es");
  });
}

function renderTasks() {
  const container = $("tasksList");
  if (!container || !currentProject) return;

  let tasks = sortTasksByDate(currentProject.tasks || []);
  if (currentTab !== "all") tasks = tasks.filter(t => t.status === currentTab);

  if (!tasks.length) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:#718096;">No hay tareas</div>';
    return;
  }

  const colors = { pending: "#e89e3c", "in-progress": "#ff7a00", completed: "#48bb78", blocked: "#f56565" };
  const labels = { pending: "Pendiente", "in-progress": "En Curso", completed: "Completada", blocked: "Bloqueada" };

  container.innerHTML = tasks.map(task => {
    const rid = task.recordId || "";
    return `
      <div class="task-item ${escapeAttr(task.status || "pending")}" onclick="editTask('${escapeAttr(rid)}')">
        <div class="task-header">
          <div class="task-title">${escapeHtml(task.name || "")}</div>
          <div class="task-status" style="background:${colors[task.status] || "#777"}; color:white;">
            ${labels[task.status] || "â€”"}
          </div>
        </div>
        <div style="color:#718096; font-size:0.9em; margin:5px 0;">${escapeHtml(task.description || "")}</div>
        <div class="task-meta">
          <div class="task-meta-item"><i class="fa-solid fa-user"></i><span>${escapeHtml(task.owner || "")}</span></div>
          <div class="task-meta-item"><i class="fa-solid fa-calendar"></i><span>${escapeHtml((task.startDate||"") + " - " + (task.endDate||""))}</span></div>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${Number(task.progress||0)}%"></div></div>
      </div>
    `;
  }).join("");
}

function parseISODateUTC(iso) {
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(Date.UTC(y, m - 1, d));
}
function daysBetweenUTC(a, b) {
  return Math.ceil((b - a) / (1000 * 60 * 60 * 24));
}

function renderGantt() {
  const container = $("ganttChart");
  if (!container || !currentProject) return;

  const tasksAll = currentProject.tasks || [];
  if (!tasksAll.length) {
    container.innerHTML = '<div style="padding:20px; color:#718096;">No hay tareas para mostrar en el Gantt</div>';
    return;
  }

  const starts = tasksAll.filter(t => t.startDate).map(t => parseISODateUTC(t.startDate));
  const ends = tasksAll.filter(t => t.endDate).map(t => parseISODateUTC(t.endDate));
  if (!starts.length || !ends.length) {
    container.innerHTML = '<div style="padding:20px; color:#718096;">Faltan startDate/endDate en tareas</div>';
    return;
  }

  let startDate = new Date(Math.min(...starts.map(d => d.getTime())));
  let endDate = new Date(Math.max(...ends.map(d => d.getTime())));
  startDate = new Date(startDate.getTime() - 7 * 86400000);
  endDate = new Date(endDate.getTime() + 7 * 86400000);

  const totalDays = Math.max(1, daysBetweenUTC(startDate, endDate));
  const monthNames = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

  const months = [];
  let cursor = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));
  const endCursor = new Date(Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), 1));
  while (cursor <= endCursor) {
    months.push(new Date(cursor.getTime()));
    cursor = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth() + 1, 1));
  }

  let html = '<div class="gantt-chart">';
  html += '<div class="gantt-header"><div class="gantt-task-name">Tarea</div><div class="gantt-timeline">';

  months.forEach(mStart => {
    const mEnd = new Date(Date.UTC(mStart.getUTCFullYear(), mStart.getUTCMonth() + 1, 1));
    const segStart = (mStart < startDate) ? startDate : mStart;
    const segEnd = (mEnd > endDate) ? endDate : mEnd;
    const segDays = Math.max(0, daysBetweenUTC(segStart, segEnd));
    const flex = segDays / totalDays;
    const label = `${monthNames[mStart.getUTCMonth()]} ${String(mStart.getUTCFullYear()).slice(2)}`;
    html += `<div style="flex:${flex}; text-align:center;">${label}</div>`;
  });

  html += "</div></div>";

  const colors = { pending: "#e89e3c", "in-progress": "#ff7a00", completed: "#48bb78", blocked: "#f56565" };
  sortTasksByDate(tasksAll).forEach(task => {
    if (!task.startDate || !task.endDate) return;
    const taskStart = parseISODateUTC(task.startDate);
    const taskEnd = parseISODateUTC(task.endDate);
    const daysFromStart = daysBetweenUTC(startDate, taskStart);
    const taskDuration = Math.max(1, daysBetweenUTC(taskStart, taskEnd));
    const left = (daysFromStart / totalDays) * 100;
    const width = (taskDuration / totalDays) * 100;

    html += `<div class="gantt-row">
      <div class="gantt-task-name">${escapeHtml(task.name || "")}</div>
      <div class="gantt-timeline">
        <div class="gantt-bar" style="left:${left}%; width:${width}%; background:${colors[task.status] || "#777"};">
          ${Number(task.progress || 0)}%
        </div>
      </div>
    </div>`;
  });

  html += "</div>";
  container.innerHTML = html;
}

function renderTeam() {
  const container = $("teamList");
  if (!container || !currentProject) return;
  const team = currentProject.team || [];
  container.innerHTML = team.map(m => `
    <div class="team-member">
      <div class="avatar">${escapeHtml(m.initials || "")}</div>
      <div class="member-info">
        <div class="member-name">${escapeHtml(m.name || "")}</div>
        <div class="member-role">${escapeHtml(m.role || "")}</div>
      </div>
    </div>
  `).join("");
}

function renderCritical() {
  const container = $("criticalList");
  if (!container || !currentProject) return;
  const critical = currentProject.critical || [];
  container.innerHTML = critical.map(c => `<div class="critical-item">${escapeHtml(c || "")}</div>`).join("");
}

function updateMetrics() {
  if (!currentProject) return;
  const tasks = currentProject.tasks || [];
  const completed = tasks.filter(t => t.status === "completed").length;
  const blocked = tasks.filter(t => t.status === "blocked").length;
  const avgProgress = tasks.length
    ? Math.round(tasks.reduce((sum, t) => sum + Number(t.progress || 0), 0) / tasks.length)
    : 0;

  let endISO = null;
  const endDates = tasks.map(t => t.endDate).filter(Boolean).sort();
  if (endDates.length) endISO = endDates[endDates.length - 1];
  else if (currentProject.meta?.ganttEnd) endISO = currentProject.meta.ganttEnd;

  let daysRemaining = "â€”";
  if (endISO) {
    const today = new Date();
    const end = new Date(endISO + "T00:00:00");
    const diff = Math.ceil((end - today) / 86400000);
    daysRemaining = String(Math.max(0, diff));
  }

  const elProg = $("metricProgress");
  const elComp = $("metricCompleted");
  const elDays = $("metricDays");
  const elBlocked = $("metricBlocked");
  if (elProg) elProg.textContent = avgProgress + "%";
  if (elComp) elComp.textContent = `${completed}/${tasks.length}`;
  if (elDays) elDays.textContent = daysRemaining;
  if (elBlocked) elBlocked.textContent = String(blocked);
}

function renderAll() {
  renderProjectMeta();
  renderTasks();
  renderGantt();
  renderTeam();
  renderCritical();
  updateMetrics();
}

// ===== Modal / CRUD =====
function showModal() {
  editingTaskRecordId = null;
  const form = $("taskForm");
  if (form) form.reset();
  const modal = $("taskModal");
  if (modal) modal.classList.add("active");
}

function closeModal() {
  const modal = $("taskModal");
  if (modal) modal.classList.remove("active");
}

function editTask(recordId) {
  if (!recordId) return;
  const task = (currentProject?.tasks || []).find(t => t.recordId === recordId);
  if (!task) return;

  editingTaskRecordId = recordId;
  $("taskName").value = task.name || "";
  $("taskDesc").value = task.description || "";
  $("taskOwner").value = task.owner || "";
  $("taskStatus").value = task.status || "pending";
  $("taskStart").value = task.startDate || "";
  $("taskEnd").value = task.endDate || "";
  $("taskProgress").value = Number(task.progress || 0);

  $("taskModal").classList.add("active");
}

async function saveTask() {
  const taskData = {
    name: $("taskName").value,
    description: $("taskDesc").value,
    owner: $("taskOwner").value,
    status: $("taskStatus").value,
    startDate: $("taskStart").value || "",
    endDate: $("taskEnd").value || "",
    progress: Number($("taskProgress").value || 0),
  };

  try {
    if (editingTaskRecordId) {
      await updateTaskRemote(editingTaskRecordId, taskData);
      const t = currentProject.tasks.find(x => x.recordId === editingTaskRecordId);
      if (t) Object.assign(t, taskData);
    } else {
      const created = await createTaskRemote(taskData);
      currentProject.tasks.push({
        ...taskData,
        recordId: created.id, // Airtable record id
      });
    }
    persistProjects();
    closeModal();
    renderTasks();
    renderGantt();
    updateMetrics();
    showConnectionStatus(true, "Guardado en Airtable");
  } catch (e) {
    console.error(e);
    showConnectionStatus(false, "Error guardando en Airtable");
    alert("Error guardando en Airtable. RevisÃ¡ consola.");
  }
}

// ===== Export =====
function exportGantt() {
  const data = JSON.stringify(currentProject, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = (currentProjectKey || "proyecto") + ".json";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== Bootstrap =====
function bindUIEvents() {
  // Tabs
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      currentTab = tab.getAttribute("data-tab");
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      renderTasks();
    });
  });

  // Task form
  const form = $("taskForm");
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      saveTask();
    });
  }
}

async function startApp() {
  try {
    projects = await loadFromBackend();
    showConnectionStatus(true, "Conectado a Airtable");
  } catch (e) {
    console.warn(e);
    const cached = loadProjectsFromStorage();
    if (cached) {
      projects = cached;
      showConnectionStatus(false, "Sin conexiÃ³n a Airtable (cache local)");
    } else {
      projects = {};
      showConnectionStatus(false, "Sin datos (no Airtable / no cache)");
    }
  }

  const keys = Object.keys(projects);
  if (!keys.length) {
    currentProjectKey = null;
    currentProject = { meta: { name: "Sin proyectos", subtitle: "", statusLabel: "" }, tasks: [], team: [], critical: [] };
  } else {
    currentProjectKey = keys[0];
    currentProject = projects[currentProjectKey];
  }

  updateProjectInfoButton(currentProjectKey);
  renderProjectSelector();
  bindUIEvents();
  renderAll();
}

// ===== HTML escaping helpers (for safe innerHTML) =====
function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function escapeAttr(str) {
  return escapeHtml(str).replaceAll("\n", " ");
}

// Expose a few functions for inline onclick handlers
window.showModal = showModal;
window.closeModal = closeModal;
window.editTask = editTask;
window.exportGantt = exportGantt;

// Start
//document.addEventListener("DOMContentLoaded", requireLoginThenStart);
    
</script>
<script>
  // === Auth bootstrap (estable) ===

  function waitForIdentity(timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const started = Date.now();
      (function tick() {
        if (window.netlifyIdentity) return resolve(window.netlifyIdentity);
        if (Date.now() - started > timeoutMs) return reject(new Error("Netlify Identity no cargÃ³ (timeout)"));
        setTimeout(tick, 120);
      })();
    });
  }

  async function startWithAuth() {
    try {
      const identity = await waitForIdentity();

      // Evita doble init por recargas / hot reload
      if (!identity.__inited) {
        identity.init();
        identity.__inited = true;
      }

      // Si ya hay sesiÃ³n, arrancamos
      const u = identity.currentUser();
      if (u) {
        console.log("[Auth] user activo:", u.email || u.id);
        await startApp(); // <-- tu arranque real
        return;
      }

      // Esperar init oficial (a veces currentUser tarda)
      identity.on("init", async (user) => {
        if (user) {
          console.log("[Auth] init con user:", user.email || user.id);
          await startApp();
        } else {
          console.log("[Auth] init sin user -> abriendo login");
          identity.open();
        }
      });

      identity.on("login", async (user) => {
        console.log("[Auth] login ok:", user.email || user.id);
        identity.close();
        await startApp();
      });

      identity.on("logout", () => {
        console.log("[Auth] logout -> open");
        identity.open();
      });

      // En algunos casos init no dispara si llegaste tarde:
      // forzamos open si despuÃ©s de 300ms sigue sin user
      setTimeout(() => {
        if (!identity.currentUser()) {
          console.log("[Auth] fallback open()");
          identity.open();
        }
      }, 300);

    } catch (e) {
      console.error("[Auth] no disponible:", e);
      alert("Auth no disponible (Identity no cargÃ³). RevisÃ¡ bloqueadores o Network.");
      // opcional: boot() sin auth si querÃ©s modo abierto, pero NO recomendado si querÃ©s seguridad
      // boot();
    }
  }

  // ================================
// UI Actions (GLOBAL) + Wiring
// ================================

function exportPDF() {
  // En web, "Exportar PDF" = abrir diÃ¡logo de impresiÃ³n (Save as PDF)
  window.print();
}

function doLogout() {
  try {
    if (window.netlifyIdentity) {
      window.netlifyIdentity.logout();
      // opcional: volver a abrir login
      window.netlifyIdentity.open();
    } else {
      alert("Auth no disponible (Netlify Identity no cargÃ³).");
    }
  } catch (e) {
    console.error("[Logout] error:", e);
  }
}

// Exponer funciones que se usan desde HTML/render dinÃ¡mico (onclick en strings)
window.exportPDF = exportPDF;
window.doLogout = doLogout;

// OJO: estas funciones tienen que EXISTIR en tu archivo.
// Si existen, las exponemos. Si no, no rompe.
if (typeof showModal === "function") window.showModal = showModal;
if (typeof closeModal === "function") window.closeModal = closeModal;
if (typeof editTask === "function") window.editTask = editTask;
if (typeof saveTask === "function") window.saveTask = saveTask;
if (typeof exportGantt === "function") window.exportGantt = exportGantt;

// Cableado de botones por ID
function wireButtons() {
  const btnNewTask = document.getElementById("btnNewTask");
  if (btnNewTask && typeof showModal === "function") {
    btnNewTask.addEventListener("click", () => showModal());
  }

  const btnLogout = document.getElementById("btnLogout");
  if (btnLogout) {
    btnLogout.addEventListener("click", () => doLogout());
  }

  const btnPrint = document.getElementById("btnPrint");
  if (btnPrint) {
    btnPrint.addEventListener("click", () => window.print());
  }

  const btnExportPdf = document.getElementById("btnExportPdf");
  if (btnExportPdf) {
    btnExportPdf.addEventListener("click", () => exportPDF());
  }
}

// Llamarlo despuÃ©s de que se renderiza el DOM (y despuÃ©s de init/boot si hace falta)
document.addEventListener("DOMContentLoaded", () => {
  wireButtons();
});


  document.addEventListener("DOMContentLoaded", startWithAuth);
</script>

    
</body>
</html>



