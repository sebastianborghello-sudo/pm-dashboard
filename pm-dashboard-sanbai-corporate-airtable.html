<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PM | Sanbai (Corporate)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #2d3748; }
        .top-bar { background: linear-gradient(135deg, #003d82 0%, #00529e 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .top-bar-left { display: flex; align-items: center; gap: 20px; }
        .logo { height: 40px; background: white; padding: 5px 15px; border-radius: 5px; font-weight: bold; color: #003d82; }
        .top-bar h1 { font-size: 1.5em; }
        .project-selector { display: flex; gap: 10px; align-items: center; }
        .project-selector select { padding: 8px 15px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-white { background: white; color: #003d82; }
        .btn-success { background: #48bb78; color: white; }
        .btn-primary { background: #003d82; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .container { padding: 20px; max-width: 1600px; margin: 0 auto; }
        .project-header { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .project-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .info-item { display: flex; flex-direction: column; gap: 5px; }
        .info-label { font-size: 0.85em; color: #718096; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1.1em; font-weight: bold; color: #2d3748; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
        .status-en-curso { background: #dbeafe; color: #1e40af; }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .left-panel { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .card-title { font-size: 1.2em; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .tasks-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: #f7fafc; border-left: 4px solid #cbd5e0; padding: 15px; border-radius: 6px; transition: all 0.3s ease; cursor: pointer; }
        .task-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .task-item.completed { border-left-color: #48bb78; opacity: 0.7; }
        .task-item.in-progress { border-left-color: #003d82; }
        .task-item.pending { border-left-color: #e89e3c; }
        .task-item.blocked { border-left-color: #f56565; }
        .task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .task-title { font-weight: 600; font-size: 1em; }
        .task-status { padding: 3px 10px; border-radius: 12px; font-size: 0.75em; font-weight: bold; }
        .task-meta { display: flex; gap: 15px; font-size: 0.85em; color: #718096; margin-top: 8px; }
        .task-meta-item { display: flex; align-items: center; gap: 5px; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #003d82 0%, #00529e 100%); transition: width 0.3s ease; }
        .gantt-container { overflow-x: auto; margin-top: 15px; }
        .gantt-chart { min-width: 800px; }
        .gantt-header { display: flex; background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 5px; font-weight: 600; font-size: 0.85em; }
        .gantt-task-name { width: 200px; flex-shrink: 0; }
        .gantt-timeline { flex: 1; display: flex; position: relative; }
        .gantt-row { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
        .gantt-row:hover { background: #f7fafc; }
        .gantt-bar { height: 24px; border-radius: 4px; position: absolute; display: flex; align-items: center; padding: 0 8px; font-size: 0.75em; color: white; font-weight: 600; white-space: nowrap; }
        .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .metric-card { background: linear-gradient(135deg, #003d82 0%, #00529e 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 61, 130, 0.3); }
        .metric-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .metric-label { font-size: 0.85em; opacity: 0.9; }
        .team-list { display: flex; flex-direction: column; gap: 10px; }
        .team-member { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f7fafc; border-radius: 8px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #003d82 0%, #00529e 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; font-size: 0.95em; }
        .member-role { font-size: 0.8em; color: #718096; }
        .critical-list { display: flex; flex-direction: column; gap: 8px; }
        .critical-item { padding: 12px; background: #fff5f5; border-left: 4px solid #f56565; border-radius: 6px; font-size: 0.9em; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #003d82; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #718096; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.3s ease; }
        .tab:hover { color: #003d82; }
        .tab.active { color: #003d82; border-bottom-color: #003d82; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }
    
        /* ===== Sanbai corporate theme overrides ===== */
        :root{
            --sanbai-orange:#ff7a00;
            --sanbai-dark:#1c1c1c;
            --sanbai-gray:#2f2f2f;
            --sanbai-light:#f5f5f5;
        }

        body{
            background: var(--sanbai-light);
            color: var(--sanbai-dark);
        }

        .top-bar{
            background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%);
            box-shadow: 0 8px 24px rgba(0,0,0,0.10);
        }

        .logo{
            display:none; /* old placeholder */
        }

        .logo-img{
            height: 34px;
            background: white;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.10);
        }

        .btn{
            border-radius: 10px;
        }

        .btn-white{
            background: white;
            color: var(--sanbai-dark);
        }

        .btn-primary{
            background: var(--sanbai-orange);
            color: white;
        }

        .btn-primary:hover{
            box-shadow: 0 10px 22px rgba(255,122,0,0.25);
        }

        .project-header{
            border-left: 6px solid var(--sanbai-orange);
        }

        .card{
            border-radius: 12px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.08);
        }

        .card-header{
            border-bottom: 1px solid #e5e7eb;
        }

        .card-title{
            color: var(--sanbai-dark);
        }

        /* Tabs */
        .tab:hover{ color: var(--sanbai-dark); }
        .tab.active{
            color: var(--sanbai-dark);
            border-bottom-color: var(--sanbai-orange);
        }

        /* Task states */
        .task-item.in-progress{ border-left-color: var(--sanbai-orange); }
        .progress-fill{
            background: linear-gradient(90deg, var(--sanbai-orange) 0%, #ff9a3d 100%);
        }

        /* Status badge */
        .status-en-curso{
            background: #fff2e8;
            color: #7a2e00;
            border: 1px solid rgba(255,122,0,0.25);
        }

        /* Metric cards: more corporate */
        .metric-card{
            background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%);
            box-shadow: 0 10px 22px rgba(0,0,0,0.12);
        }
        .metric-card.metric-accent{
            background: linear-gradient(135deg, var(--sanbai-orange) 0%, #ff9a3d 100%);
            box-shadow: 0 10px 22px rgba(255,122,0,0.20);
        }
        .metric-card.metric-ok{
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        }
        .metric-card.metric-warn{
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        .metric-card.metric-bad{
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }

        /* Avatars */
        .avatar{
            background: linear-gradient(135deg, var(--sanbai-dark) 0%, var(--sanbai-gray) 100%);
        }

        /* Print / PDF */
        @media print{
            .top-bar{ box-shadow:none; }
            .btn, .project-selector, .tabs, .modal{ display:none !important; }
            body{ background:white; }
            .container{ max-width:none; padding:0; }
            .card{ box-shadow:none; border:1px solid #e5e7eb; }
            .project-header{ box-shadow:none; border:1px solid #e5e7eb; border-left: 6px solid var(--sanbai-orange); }
            .main-content{ grid-template-columns: 1fr; }
            .right-panel{ break-before: page; }
        }

    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="logo.png" class="logo-img" alt="Sanbai Solutions">
            <h1>Dashboard PM</h1>
        </div>
        <div class="project-selector">
            <select id="projectSelector"></select>
            <button class="btn btn-white" onclick="alert('Próximamente')"><i class="fa-solid fa-plus"></i> Nuevo</button>
        </div>
    </div>

    <div class="container">
        <div class="project-header">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h2>Torre Macro - Red LAN</h2>
                    <p style="color: #718096; margin-top: 5px;">Actualización Tecnológica Infraestructura Red Cableada Huawei</p>
                </div>
                <span class="status-badge status-en-curso">En Curso</span>
            </div>
            <div class="project-info-grid">
                <div class="info-item"><span class="info-label">Cliente</span><span class="info-value">Banco Macro S.A.</span></div>
                <div class="info-item"><span class="info-label">Monto</span><span class="info-value">USD 1,190,682.80</span></div>
                <div class="info-item"><span class="info-label">Inicio</span><span class="info-value">01/03/2026</span></div>
                <div class="info-item"><span class="info-label">Fin Estimado</span><span class="info-value">01/11/2026</span></div>
                <div class="info-item"><span class="info-label">PM Responsable</span><span class="info-value">Sebastián Pittaluga</span></div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fa-solid fa-list-check"></i> Tareas del Proyecto</span>
                        <button class="btn btn-primary" onclick="showModal()"><i class="fa-solid fa-plus"></i> Nueva Tarea</button>
                    </div>
                    <div class="tabs">
                        <div class="tab active" data-tab="all">Todas</div>
                        <div class="tab" data-tab="pending">Pendientes</div>
                        <div class="tab" data-tab="in-progress">En Curso</div>
                        <div class="tab" data-tab="completed">Completadas</div>
                    </div>
                    <div id="tasksList" class="tasks-list"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fa-solid fa-chart-gantt"></i> Cronograma (Gantt)</span>
                        <button class="btn btn-white" onclick="exportGantt()"><i class="fa-solid fa-download"></i> Exportar</button>
                    </div>
                    <div class="gantt-container" id="ganttChart"></div>
                </div>
            </div>

            <div class="right-panel">
                <div class="card">
                    <div class="card-title" style="margin-bottom: 15px;"><i class="fa-solid fa-chart-line"></i> Métricas</div>
                    <div class="metrics-grid">
                        <div class="metric-card metric-accent"><div class="metric-label">Progreso Total</div><div class="metric-value" id="metricProgress">15%</div></div>
                        <div class="metric-card metric-ok"><div class="metric-label">Completadas</div><div class="metric-value" id="metricCompleted">1/5</div></div>
                        <div class="metric-card metric-warn"><div class="metric-label">Días Restantes</div><div class="metric-value" id="metricDays">180</div></div>
                        <div class="metric-card metric-bad"><div class="metric-label">Bloqueadores</div><div class="metric-value" id="metricBlocked">1</div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title" style="margin-bottom: 15px;"><i class="fa-solid fa-users"></i> Equipo</div>
                    <div class="team-list" id="teamList"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> Riesgos y Bloqueadores</span>
                        <button class="btn btn-danger" onclick="alert('Próximamente')">➕</button>
                    </div>
                    <div class="critical-list" id="criticalList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Nueva Tarea</div>
            <form id="taskForm">
                <div class="form-group"><label class="form-label">Nombre</label><input type="text" class="form-input" id="taskName" required></div>
                <div class="form-group"><label class="form-label">Descripción</label><textarea class="form-textarea" id="taskDesc" rows="3"></textarea></div>
                <div class="form-group"><label class="form-label">Responsable</label><select class="form-select" id="taskOwner"><option>Sebastián Pittaluga</option><option>Luis 
                </option><option>Sebastian Borghello</option><option>Huawei</option><option>Qualix</option></select></div>
                <div class="form-group"><label class="form-label">Estado</label><select class="form-select" id="taskStatus"><option value="pending">Pendiente</option><option value="in-progress">En Curso</option><option value="completed">Completada</option><option value="blocked">Bloqueada</option></select></div>
                <div class="form-group"><label class="form-label">Fecha Inicio</label><input type="date" class="form-input" id="taskStart"></div>
                <div class="form-group"><label class="form-label">Fecha Fin</label><input type="date" class="form-input" id="taskEnd"></div>
                <div class="form-group"><label class="form-label">Progreso (%)</label><input type="number" class="form-input" id="taskProgress" min="0" max="100" value="0"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-white" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const STORAGE_KEY = "pm_projects_v1";

function persistProjects() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
  } catch (e) {
    console.error("No se pudo guardar en localStorage:", e);
  }
}

function loadProjectsFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    Object.keys(parsed).forEach((k) => {
      projects[k] = parsed[k];
    });
  } catch (e) {
    console.error("No se pudo leer localStorage:", e);
  }
}

        function renderProjectSelector() {
  const sel = document.getElementById('projectSelector');
  sel.innerHTML = Object.entries(projects)
    .map(([key, p]) => `<option value="${key}">${p.meta.name}</option>`)
    .join('');
    

  sel.value = currentProjectKey;

  sel.addEventListener('change', () => {
    currentProjectKey = sel.value;
    currentProject = projects[currentProjectKey];
    persistProjects();
    currentTab = 'all';
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-tab="all"]').classList.add('active');
    renderProjectMeta();
    renderTasks();
    renderGantt();
    renderTeam();
    renderCritical();
    updateMetrics();
  });
}

function renderProjectMeta() {
  // Cambia textos del header SIN cambiar tu diseño
  document.querySelector('.project-header h2').textContent = currentProject.meta.name;
  document.querySelector('.project-header p').textContent = currentProject.meta.subtitle;
  document.querySelector('.status-badge').textContent = currentProject.meta.statusLabel;

  const infoValues = document.querySelectorAll('.project-info-grid .info-value');
  // Orden actual: Cliente, Monto, Inicio, Fin, PM Responsable
  infoValues[0].textContent = currentProject.meta.client;
  infoValues[1].textContent = currentProject.meta.amount;
  infoValues[2].textContent = currentProject.meta.start;
  infoValues[3].textContent = currentProject.meta.end;
  infoValues[4].textContent = currentProject.meta.pm;
}

        let projects = {
  macro_lan: {
    meta: {
      name: "Torre Macro - Red LAN",
      subtitle: "Actualización Tecnológica Infraestructura Red Cableada Huawei",
      statusLabel: "En Curso",
      client: "Banco Macro S.A.",
      amount: "USD 1,190,682.80",
      start: "01/03/2026",
      end: "01/11/2026",
      pm: "Sebastián Pittaluga",
      ganttStart: "2026-03-01",
      ganttEnd: "2026-11-01"
    },
    tasks: [
      { id: 1, name: "Importación Hardware", description: "Fabricación y transporte", owner: "Huawei", status: "in-progress", progress: 25, startDate: "2026-03-01", endDate: "2026-04-30" },
      { id: 2, name: "Relevamiento", description: "Inspección física", owner: "Qualix", status: "pending", progress: 0, startDate: "2026-03-15", endDate: "2026-03-29" },
      { id: 3, name: "Diseño HLD/LLD", description: "Documentación técnica", owner: "Huawei", status: "pending", progress: 0, startDate: "2026-04-01", endDate: "2026-05-15" },
      { id: 4, name: "Instalación Core", description: "Switches core", owner: "Sebastián Pittaluga", status: "pending", progress: 0, startDate: "2026-05-01", endDate: "2026-06-15" },
      { id: 5, name: "Configuración ISE", description: "Integración NAC", owner: "Luis", status: "blocked", progress: 0, startDate: "2026-06-01", endDate: "2026-07-01" }
    ],
    team: [
      { name: "Sebastián Pittaluga", role: "PM Principal", initials: "SP" },
      { name: "Luis Gomez", role: "PM Huawei", initials: "LG" },
      { name: "Sebastian Borghello", role: "Enterprise", initials: "SB" },
      { name: "Huawei", role: "LLD & MOP", initials: "H" },
      { name: "Qualix", role: "Instalación", initials: "Q" }
    ],
    critical: ["Validar condiciones para instalación Core", "Confirmar recepción y staging de equipamiento", "Definir responsable de ISE / NAC"]
  },

  // Ejemplo 2 (duplicá este bloque para nuevos proyectos)
  core_storage: {
    meta: {
      name: "Banco Macro - Core Storage",
      subtitle: "Actualización y expansión de almacenamiento",
      statusLabel: "Planificación",
      client: "Banco Macro S.A.",
      amount: "USD --",
      start: "--/--/----",
      end: "--/--/----",
      pm: "Sebastián Pittaluga",
      ganttStart: "2026-02-01",
      ganttEnd: "2026-08-01"
    },
    tasks: [],
    team: [],
    critical: []
  }
  
};
loadProjectsFromStorage();
  let currentProjectKey = "macro_lan";
  let currentProject = projects[currentProjectKey];
        let currentTab = 'all';
        let editingTaskId = null;

function resetStorage() {
  localStorage.removeItem(STORAGE_KEY);
  alert("Storage limpiado. Refrescá la página.");
}


        function init() {
            renderProjectSelector();
            renderProjectMeta();
            renderTasks();
            renderGantt();
            renderTeam();
            renderCritical();
            updateMetrics();
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    currentTab = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    renderTasks();
                });
            });

            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTask();
            });
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            let tasks = currentProject.tasks;
            if (currentTab !== 'all') tasks = tasks.filter(t => t.status === currentTab);
            
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">No hay tareas</div>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const colors = { pending: '#e89e3c', 'in-progress': '#003d82', completed: '#48bb78', blocked: '#f56565' };
                const labels = { pending: 'Pendiente', 'in-progress': 'En Curso', completed: 'Completada', blocked: 'Bloqueada' };
                return `
                    <div class="task-item ${task.status}" onclick="editTask(${task.id})">
                        <div class="task-header">
                            <div class="task-title">${task.name}</div>
                            <div class="task-status" style="background: ${colors[task.status]}; color: white;">${labels[task.status]}</div>
                        </div>
                        <div style="color: #718096; font-size: 0.9em; margin: 5px 0;">${task.description}</div>
                        <div class="task-meta">
                            <div class="task-meta-item"><i class="fa-solid fa-user"></i><span>${task.owner}</span></div>
                            <div class="task-meta-item"><i class="fa-solid fa-calendar"></i><span>${task.startDate} - ${task.endDate}</span></div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${task.progress}%"></div></div>
                    </div>
                `;
            }).join('');
        }
function parseISODateUTC(iso) {
  // iso = "YYYY-MM-DD"
  const [y, m, d] = iso.split("-").map(Number);
  return new Date(Date.UTC(y, m - 1, d));
}

function daysBetweenUTC(a, b) {
  return Math.ceil((b - a) / (1000 * 60 * 60 * 24));
}

      function renderGantt() {
  const container = document.getElementById('ganttChart');

  if (!currentProject.tasks || currentProject.tasks.length === 0) {
    container.innerHTML = '<div style="padding: 20px; color:#718096;">No hay tareas para mostrar en el Gantt</div>';
    return;
  }

  // 1) Calcular rango real en base a tareas (min start, max end)
  const starts = currentProject.tasks
    .filter(t => t.startDate)
    .map(t => parseISODateUTC(t.startDate));
  const ends = currentProject.tasks
    .filter(t => t.endDate)
    .map(t => parseISODateUTC(t.endDate));

  if (starts.length === 0 || ends.length === 0) {
    container.innerHTML = '<div style="padding: 20px; color:#718096;">Faltan startDate/endDate en tareas</div>';
    return;
  }

  let startDate = new Date(Math.min(...starts.map(d => d.getTime())));
  let endDate = new Date(Math.max(...ends.map(d => d.getTime())));

  // 2) Padding para que respire (7 días a cada lado)
  startDate = new Date(startDate.getTime() - 7 * 24 * 60 * 60 * 1000);
  endDate = new Date(endDate.getTime() + 7 * 24 * 60 * 60 * 1000);

  const totalDays = Math.max(1, daysBetweenUTC(startDate, endDate));

  // 3) Header dinámico por meses dentro del rango
  const monthNames = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

  function monthKey(d) { return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`; }

  // construir lista de meses entre startDate y endDate
  const months = [];
  let cursor = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));
  const endCursor = new Date(Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), 1));

  while (cursor <= endCursor) {
    months.push(new Date(cursor.getTime()));
    cursor = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth() + 1, 1));
  }

  let html = '<div class="gantt-chart">';
  html += '<div class="gantt-header"><div class="gantt-task-name">Tarea</div><div class="gantt-timeline">';

  // Cada mes ocupa proporcionalmente su cantidad de días dentro del rango
  months.forEach(mStart => {
    const mEnd = new Date(Date.UTC(mStart.getUTCFullYear(), mStart.getUTCMonth() + 1, 1));
    const segStart = (mStart < startDate) ? startDate : mStart;
    const segEnd = (mEnd > endDate) ? endDate : mEnd;
    const segDays = Math.max(0, daysBetweenUTC(segStart, segEnd));
    const flex = segDays / totalDays;

    const label = `${monthNames[mStart.getUTCMonth()]} ${String(mStart.getUTCFullYear()).slice(2)}`;
    html += `<div style="flex:${flex}; text-align:center;">${label}</div>`;
  });

  html += '</div></div>';

  // 4) Rows
  currentProject.tasks.forEach(task => {
    if (!task.startDate || !task.endDate) return;

    const taskStart = parseISODateUTC(task.startDate);
    const taskEnd = parseISODateUTC(task.endDate);

    const daysFromStart = daysBetweenUTC(startDate, taskStart);
    const taskDuration = Math.max(1, daysBetweenUTC(taskStart, taskEnd));

    const left = (daysFromStart / totalDays) * 100;
    const width = (taskDuration / totalDays) * 100;

    const colors = { pending: '#e89e3c', 'in-progress': '#003d82', completed: '#48bb78', blocked: '#f56565' };

    html += `<div class="gantt-row">
      <div class="gantt-task-name">${task.name}</div>
      <div class="gantt-timeline">
        <div class="gantt-bar" style="left:${left}%; width:${width}%; background:${colors[task.status] || '#003d82'};">
          ${task.progress || 0}%
        </div>
      </div>
    </div>`;
  });

  html += '</div>';
  container.innerHTML = html;
}


        function renderTeam() {
            const container = document.getElementById('teamList');
            container.innerHTML = currentProject.team.map(m => `
                <div class="team-member">
                    <div class="avatar">${m.initials}</div>
                    <div class="member-info"><div class="member-name">${m.name}</div><div class="member-role">${m.role}</div></div>
                </div>
            `).join('');
        }

        function renderCritical() {
            const container = document.getElementById('criticalList');
            container.innerHTML = currentProject.critical.map(c => `<div class="critical-item">${c}</div>`).join('');
        }

        function updateMetrics() {
            const completed = currentProject.tasks.filter(t => t.status === 'completed').length;
            const blocked = currentProject.tasks.filter(t => t.status === 'blocked').length;
            const avgProgress = currentProject.tasks.length
                ? Math.round(currentProject.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / currentProject.tasks.length)
                : 0;

            // Días restantes: tomamos la última endDate de tareas; si no hay, usamos meta.ganttEnd
            let endISO = null;
            const endDates = (currentProject.tasks || [])
                .map(t => t.endDate)
                .filter(Boolean)
                .sort();
            if (endDates.length) endISO = endDates[endDates.length - 1];
            else if (currentProject.meta && currentProject.meta.ganttEnd) endISO = currentProject.meta.ganttEnd;

            let daysRemaining = '—';
            if (endISO) {
                const today = new Date();
                const end = new Date(endISO + 'T00:00:00');
                const diff = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                daysRemaining = String(Math.max(0, diff));
            }

            document.getElementById('metricProgress').textContent = avgProgress + '%';
            document.getElementById('metricCompleted').textContent = `${completed}/${currentProject.tasks.length}`;
            const elDays = document.getElementById('metricDays');
            if (elDays) elDays.textContent = daysRemaining;
            document.getElementById('metricBlocked').textContent = blocked;
        }

        function showModal() {
            editingTaskId = null;
            document.getElementById('taskForm').reset();
            document.getElementById('taskModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        function editTask(id) {
            const task = currentProject.tasks.find(t => t.id === id);
            if (!task) return;
            
            editingTaskId = id;
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskDesc').value = task.description;
            document.getElementById('taskOwner').value = task.owner;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskStart').value = task.startDate;
            document.getElementById('taskEnd').value = task.endDate;
            document.getElementById('taskProgress').value = task.progress;
            document.getElementById('taskModal').classList.add('active');
        }

        function saveTask() {
            const taskData = {
                name: document.getElementById('taskName').value,
                description: document.getElementById('taskDesc').value,
                owner: document.getElementById('taskOwner').value,
                status: document.getElementById('taskStatus').value,
                startDate: document.getElementById('taskStart').value,
                endDate: document.getElementById('taskEnd').value,
                progress: parseInt(document.getElementById('taskProgress').value)
            };

            if (editingTaskId) {
                const task = currentProject.tasks.find(t => t.id === editingTaskId);
                Object.assign(task, taskData);
            } else {
                taskData.id = currentProject.tasks.length + 1;
                currentProject.tasks.push(taskData);

            }
            persistProjects();


            closeModal();
            renderTasks();
            renderGantt();
            updateMetrics();
        }

        function exportGantt() {
            const data = JSON.stringify(currentProject, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'proyecto-torre-macro.json';
            a.click();
        }

        async function loadFromBackend() {
            // Netlify Function (recommended). Returns: { projects: { ... } }
            const r = await fetch('/.netlify/functions/airtable', { cache: 'no-store' });
            if (!r.ok) {
                const t = await r.text();
                throw new Error(`Airtable backend error: ${r.status} ${t}`);
            }
            const data = await r.json();
            if (!data || !data.projects) throw new Error('Respuesta inválida del backend');
            return data.projects;
        }

        function showConnectionStatus(ok, msg) {
            let el = document.getElementById('connStatus');
            if (!el) {
                el = document.createElement('div');
                el.id = 'connStatus';
                el.style.position = 'fixed';
                el.style.bottom = '16px';
                el.style.left = '16px';
                el.style.padding = '10px 12px';
                el.style.borderRadius = '10px';
                el.style.fontSize = '12px';
                el.style.fontWeight = '600';
                el.style.zIndex = '2000';
                el.style.boxShadow = '0 10px 22px rgba(0,0,0,0.12)';
                document.body.appendChild(el);
            }
            if (ok) {
                el.textContent = msg || 'Conectado a Airtable';
                el.style.background = 'rgba(34,197,94,0.95)';
                el.style.color = 'white';
            } else {
                el.textContent = msg || 'Sin conexión a Airtable (modo local)';
                el.style.background = 'rgba(245,158,11,0.95)';
                el.style.color = 'white';
            }
            setTimeout(() => { try { el.remove(); } catch(e){} }, 8000);
        }

        async function boot() {
            // 1) Intentar cargar desde backend (seguro). 2) Si falla, usar datos embebidos.
            try {
                const remoteProjects = await loadFromBackend();
                // Reemplazar proyectos por los del backend
                projects = remoteProjects;
                // Aplicar overrides locales encima (si existieran)
                loadProjectsFromStorage();
                showConnectionStatus(true, 'Conectado a Airtable');
            } catch (e) {
                // Fallback local + storage
                loadProjectsFromStorage();
                showConnectionStatus(false, 'Sin conexión a Airtable (modo local)');
                console.warn(e);
            }

            // Elegir proyecto inicial
            const keys = Object.keys(projects);
            if (!keys.length) {
                // Evitar crash si no hay datos
                projects = {};
                currentProjectKey = null;
                currentProject = { meta: { name: 'Sin proyectos', subtitle: '', statusLabel: '' }, tasks: [], team: [], critical: [] };
            } else {
                if (!currentProjectKey || !projects[currentProjectKey]) currentProjectKey = keys[0];
                currentProject = projects[currentProjectKey];
            }

            init();
        }

        boot();
    </script>
</body>
</html>